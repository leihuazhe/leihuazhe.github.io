<!doctype html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta><title>APP接口安全TOKEN设计 - 非普通程序员</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="非普通程序员"><meta name="msapplication-TileImage" content="/img/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="非普通程序员"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="APP接口安全TOKEN设计"><meta property="og:type" content="blog"><meta property="og:title" content="APP接口安全TOKEN设计"><meta property="og:url" content="http://leihuazhe.github.io/p/821bbecd.html"><meta property="og:site_name" content="非普通程序员"><meta property="og:description" content="APP接口安全TOKEN设计"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://leihuazhe.github.io/img/og_image.png"><meta property="article:published_time" content="2017-09-01T15:14:12.000Z"><meta property="article:modified_time" content="2021-05-06T04:35:14.644Z"><meta property="article:author" content="Zane Ray"><meta property="article:tag" content="java"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://leihuazhe.github.io/p/821bbecd.html"},"headline":"非普通程序员","image":["http://leihuazhe.github.io/img/og_image.png"],"datePublished":"2017-09-01T15:14:12.000Z","dateModified":"2021-05-06T04:35:14.644Z","author":{"@type":"Person","name":"Zane Ray"},"description":"APP接口安全TOKEN设计"}</script><link rel="canonical" href="http://leihuazhe.github.io/p/821bbecd.html"><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/github.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/maple.png" alt="非普通程序员" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于我</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/leihuazhe"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"><i class="fas fa-angle-double-right"></i>APP接口安全TOKEN设计</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time datetime="${date_xml(page.date)}" title="${date_xml(page.date)}">2017-09-01</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time datetime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2021-05-06</time></span><span class="level-item"><a class="link-muted" href="/categories/java/">java</a></span><span class="level-item">22 分钟读完 (大约3353个字)</span></div></div><div class="content"><h4 id="你是否真的需要登录功能？"><a href="#你是否真的需要登录功能？" class="headerlink" title="你是否真的需要登录功能？"></a>你是否真的需要登录功能？</h4><p>把这个问题放在最前面并不是灌水，而是真的见过很多并不需要登录的APP去做了登录功能，或者是并不需要强制登录的APP把登录作为启动页。<br>用户对你的APP一无所知，你就要求对方注册并登录，除非APP本身已经很有名气或者是用户有强需求，否则正常人应该会直接把它删掉。<br>比较温和的方式是将一些并不需要登录，但可以给用户带来帮助的东西，第一时间展现给他们，让他们产生兴趣，再在合适的时机引导他们注册（比如使用需要使用更高级的功能，或用户需要收藏某个喜欢的信息时）。</p><span id="more"></span><h4 id="登录和注册要足够简单"><a href="#登录和注册要足够简单" class="headerlink" title="登录和注册要足够简单"></a>登录和注册要足够简单</h4><p>这是小小的手机端，用再好的输入法，打字也是不方便的，所以别把登录页设计得需要填很多东西。如果有可能的话，只填手机号，让用户收到短信验证码就完成注册是最好不过的了。想获得更多信息？想想大公司的APP是怎么做的，他们会告诉用户，现在的个人资料完善程度是30%，如果想获得更多积分，你需要填完。<br><code>tips:</code>如果你想发布在<code>Appstore</code>并且同时包含注册功能，那么注册页面必须做一个用户许可协议的链接，否则有可能通不过审核。</p><h4 id="实现登录后的session有几种方式？"><a href="#实现登录后的session有几种方式？" class="headerlink" title="实现登录后的session有几种方式？"></a>实现登录后的session有几种方式？</h4><h6 id="APP当浏览器用，直接载入远程页面"><a href="#APP当浏览器用，直接载入远程页面" class="headerlink" title="APP当浏览器用，直接载入远程页面"></a>APP当浏览器用，直接载入远程页面</h6><p>这种情况是很多偷懒的程序员或者傻X的老板选择的方式，因为做起来实在太快。如果本身网站是响应式布局，那么很有可能不需要做什么更改，就只要在开发时打开首页就好了，这样Hybird的APP外壳就纯粹成为了一个浏览器。<br>但比起这样做带来的无数缺点来，开发速度快的优点几乎可以忽略不计。<br>首先，在网络环境不佳时，纯大白页，用户体验0；<br>然后，CSS和JS等资源不在本地，需要远程载入，如果使用了bootstrap之类的框架，那用户为了开一下APP而耗费的流量真是令人感动；<br>再然后，网页里常用的jquery，在手机的webview里速度并不理想，而如果是非ajax的网页那就更糟心了，每次操作都要跳转和页面渲染，要让人把它当成APP那实在是笑话。<br>再再然后，这样的所谓APP，要通过Appstore的审查，那是做梦的（除非审核员当天闹肚子严重，拿着纸巾奔向厕所前误点了通过……），苹果的要求是，这得是APP，而不能是某个网站做成APP的样子，那样的情况适合做Web APP。而据我所知，国内几个较大的Android市场，这样的APP也是无法通过审核的。</p><h6 id="调用后端接口"><a href="#调用后端接口" class="headerlink" title="调用后端接口"></a>调用后端接口</h6><p>这是个很好的时代，因为无论后端你是用<code>Java</code>、<code>PHP</code>，还是<code>node.js</code>，都可以通过<code>xml</code>、<code>json</code>来和<code>APP</code>通讯。<br>把刚才那个用<code>APP</code>当浏览器使的案例的所有缺点反过来看，就是这样做的优点，在优化完善的情况下体验接近原生，而且通讯流量极少，通过各种审核也是妥妥的。<br><code>tips:</code>通过plus对象中的<a target="_blank" rel="noopener" href="http://www.dcloud.io/docs/api/zh_cn/xhr.shtml">XMLHttpRequest</a>来Get、Post远程的后端接口，或者使用Mui中封装好的<a target="_blank" rel="noopener" href="http://dcloudio.github.io/mui/javascript">AJAX相关函数</a>。</p><p>插一段代码，我把<code>mui</code>的<code>ajax</code>又做了进一步的封装，对超时进行了自动重试，而对<code>invalid_token</code>等情况也做相应处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mui.web_query = function(func_url, params, onSuccess, onError, retry)&#123;</span><br><span class="line">    <span class="keyword">var</span> onSuccess = arguments[<span class="number">2</span>]?arguments[<span class="number">2</span>]:function()&#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> onError = arguments[<span class="number">3</span>]?arguments[<span class="number">3</span>]:function()&#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> retry = arguments[<span class="number">4</span>]?arguments[<span class="number">4</span>]:<span class="number">3</span>;</span><br><span class="line">    func_url = <span class="string">&#x27;http://www.xxxxxx.com/ajax/?fn=&#x27;</span> + func_url;</span><br><span class="line">    mui.ajax(func_url, &#123;</span><br><span class="line">        data:params,</span><br><span class="line">        dataType:<span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">        type:<span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">        timeout:<span class="number">3000</span>,</span><br><span class="line">        success:function(data)&#123;</span><br><span class="line">            <span class="keyword">if</span>(data.err === <span class="string">&#x27;ok&#x27;</span>)&#123;</span><br><span class="line">                onSuccess(data);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                onError(data.code);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        error:function(xhr,type,errorThrown)&#123;</span><br><span class="line">            retry--;</span><br><span class="line">            <span class="keyword">if</span>(retry &gt; <span class="number">0</span>) <span class="keyword">return</span> mui.web_query(func_url, params, onSuccess, onError, retry);</span><br><span class="line">            onError(<span class="string">&#x27;FAILED_NETWORK&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> onError = function(errcode)&#123;</span><br><span class="line">    <span class="keyword">switch</span>(errcode)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;FAILED_NETWORK&#x27;</span>:</span><br><span class="line">        mui.toast(<span class="string">&#x27;网络不佳&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;INVALID_TOKEN&#x27;</span>:</span><br><span class="line">        wv_login.show();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        console.log(errcode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> params = &#123;per:<span class="number">10</span>, pageno:coms_current_pageno&#125;;</span><br><span class="line">mui.web_query(<span class="string">&#x27;get_com_list&#x27;</span>, params, onSuccess, onError, <span class="number">3</span>);</span><br></pre></td></tr></table></figure><h4 id="调用后端接口怎么样才安全？"><a href="#调用后端接口怎么样才安全？" class="headerlink" title="调用后端接口怎么样才安全？"></a>调用后端接口怎么样才安全？</h4><h6 id="在APP中保存登录数据，每次调用接口时传输"><a href="#在APP中保存登录数据，每次调用接口时传输" class="headerlink" title="在APP中保存登录数据，每次调用接口时传输"></a>在APP中保存登录数据，每次调用接口时传输</h6><p>程序员总能给自己找到偷懒的方法，有的程序为了省事，会在用户登录后，直接把用户名和密码保存在本地，然后每次调用后端接口时作为参数传递。真省事儿啊！可这种方法简单就像拿着一袋子钱在路上边走边喊“快来抢我呀！快来抢我呀！”，一个小小的嗅探器就能把用户的密码拿到手，如果用户习惯在所有地方用一个密码，那么你闯大祸了，黑客通过撞库的方法能把用户的所有信息一锅端。</p><h6 id="登录时请求一次token，之后用token调用接口"><a href="#登录时请求一次token，之后用token调用接口" class="headerlink" title="登录时请求一次token，之后用token调用接口"></a>登录时请求一次token，之后用token调用接口</h6><p>这是比较安全的方式，用户在登录时，APP调用获取token的接口（比如<a target="_blank" rel="noopener" href="http://api.abc.com/get_token/%EF%BC%89%EF%BC%8C%E7%94%A8post%E5%B0%86%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81%E7%9A%84%E6%91%98%E8%A6%81%E4%BC%A0%E9%80%92%E7%BB%99%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E7%84%B6%E5%90%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%AF%94%E5%AF%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%8C%B9%E9%85%8D%E5%88%99%E8%BF%94%E5%9B%9E%E7%BB%91%E5%AE%9A%E8%AF%A5%E7%94%A8%E6%88%B7%E7%9A%84token%EF%BC%88%E8%BF%99%E4%B8%80%E8%88%AC%E7%BF%BB%E8%AF%91%E4%B8%BA%E4%BB%A4%E7%89%8C%EF%BC%8C%E5%BE%88%E7%9B%B4%E8%A7%82%E7%9A%84%E5%90%8D%E5%AD%97%EF%BC%8C%E4%B8%80%E7%9C%8B%E5%B0%B1%E7%9F%A5%E9%81%93%E6%98%AF%E6%9C%89%E4%BA%86%E8%BF%99%E7%8E%A9%E6%84%8F%EF%BC%8C%E5%B0%B1%E4%BC%9A%E5%AF%B9%E4%BD%A0%E6%94%BE%E8%A1%8C%EF%BC%89%EF%BC%8C%E8%80%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%EF%BC%8C%E5%9C%A8%E7%94%A8%E6%88%B7%E7%9A%84token%E8%A1%A8%E4%B8%AD%E4%B9%9F%E5%90%8C%E6%97%B6%E6%8F%92%E5%85%A5%E4%BA%86%E8%BF%99%E4%B8%AAtoken%E7%9B%B8%E5%85%B3%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%9A%E8%BF%99%E4%B8%AAtoken%E5%B1%9E%E4%BA%8E%E8%B0%81%EF%BC%9F%E8%BF%99%E4%B8%AAtoken%E7%9A%84%E6%9C%89%E6%95%88%E6%9C%9F%E6%98%AF%E5%A4%9A%E4%B9%85%EF%BC%9F%E8%BF%99%E4%B8%AAtoken%E5%BD%93%E5%89%8D%E7%99%BB%E5%BD%95%E7%9A%84ip%E5%9C%B0%E5%9D%80%E6%98%AF%EF%BC%9F%E8%BF%99%E4%B8%AAtoken%E5%AF%B9%E5%BA%94%E7%9A%84deviceid%E6%98%AF%EF%BC%9F%E2%80%A6%E2%80%A6">http://api.abc.com/get_token/），用post将用户名和密码的摘要传递给服务器，然后服务器比对数据库中的用户信息，匹配则返回绑定该用户的token（这一般翻译为令牌，很直观的名字，一看就知道是有了这玩意，就会对你放行），而数据库中，在用户的token表中也同时插入了这个token相关的数据：这个token属于谁？这个token的有效期是多久？这个token当前登录的ip地址是？这个token对应的deviceid是？……</a><br>这样即便token被有心人截获，也不会造成太大的安全风险。因为没有用户名和密码，然后如果黑客通过这个token伪造用户请求，我们在服务器端接口被调用时就可以对发起请求的ip地址、user-agent之类的信息作比对，以防止伪造。再然后，如果token的有效期设得小，过一会儿它就过期了，除非黑客可以持续截获你的token，否则他只能干瞪眼。（插一句题外话：看到这里，是不是明白为什么不推荐在外面随便接入来历不明的wifi热点了？）<br><code>tips:</code>token如何生成？ 可以根据用户的信息及一些随机信息（比如时间戳）再通过hash编码（比如md5、sha1等）生成唯一的编码。<br><code>tips:</code>token的安全级别，取决于你的实际需求，所以如果不是涉及财产安全的领域，并不建议太严格（比如用户走着走着，3G换了个基站，闪断了一下IP地址变了，尼玛token过期了，这就属于为了不必要的安全丢了用户体验，当然如果变换的IP地址跨省的话还是应该验证一下的，想想QQ有时候会让填验证码就明白了）。<br><code>tips:</code>接口在返回信息时，可以包含本次请求的状态，比如成功调用，那么result[‘status’]可能就是’success’，而反之则是’error’，而如果是’error’，则result[‘errcode’]中就可以包含错误的原因，比如errcode中是’invalid_token’就可以告诉APP这个token过期或无效，这时APP应弹出登录框或者用本地存储的用户名或密码再次请求token（用户选择“记住密码”，就应该在本地保存用户名和密码的摘要，方法见plus.storage的文档）。</p><p>再插点代码，基于plus.storage的用户信息类，注意：需要在plusReady之后再使用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">UserInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//清除登录信息</span></span><br><span class="line">UserInfo.clear = function()&#123;</span><br><span class="line">    plus.storage.removeItem(<span class="string">&#x27;username&#x27;</span>);</span><br><span class="line">    plus.storage.removeItem(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">    plus.storage.removeItem(<span class="string">&#x27;token&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查是否包含自动登录的信息</span></span><br><span class="line">UserInfo.auto_login = function()&#123;</span><br><span class="line">    <span class="keyword">var</span> username = UserInfo.username();</span><br><span class="line">    <span class="keyword">var</span> pwd = UserInfo.password();</span><br><span class="line">    <span class="keyword">if</span>(!username || !pwd)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查是否已登录</span></span><br><span class="line">UserInfo.has_login = function()&#123;</span><br><span class="line">    <span class="keyword">var</span> username = UserInfo.username();</span><br><span class="line">    <span class="keyword">var</span> pwd = UserInfo.password();</span><br><span class="line">    <span class="keyword">var</span> token = UserInfo.token();</span><br><span class="line">    <span class="keyword">if</span>(!username || !pwd || !token)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">UserInfo.username = function()&#123;</span><br><span class="line">    <span class="keyword">if</span>(arguments.length == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> plus.storage.getItem(<span class="string">&#x27;username&#x27;</span>);        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(arguments[<span class="number">0</span>] === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">        plus.storage.removeItem(<span class="string">&#x27;username&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    plus.storage.setItem(<span class="string">&#x27;username&#x27;</span>, arguments[<span class="number">0</span>]);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">UserInfo.password = function()&#123;</span><br><span class="line">    <span class="keyword">if</span>(arguments.length == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> plus.storage.getItem(<span class="string">&#x27;password&#x27;</span>);        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(arguments[<span class="number">0</span>] === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">        plus.storage.removeItem(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    plus.storage.setItem(<span class="string">&#x27;password&#x27;</span>, arguments[<span class="number">0</span>]);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">UserInfo.token = function()&#123;</span><br><span class="line">    <span class="keyword">if</span>(arguments.length == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> plus.storage.getItem(<span class="string">&#x27;token&#x27;</span>);       </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(arguments[<span class="number">0</span>] === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">        plus.storage.removeItem(<span class="string">&#x27;token&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    plus.storage.setItem(<span class="string">&#x27;token&#x27;</span>, arguments[<span class="number">0</span>]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这样当用户启动APP或使用了需要登录才能使用的功能时，就可以使用UserInfo.has_login()来判断是否已经登录，如果已登录，则使用UserInfo.token()来获取到token数据，作为参数调用远程的后端接口。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if(UserInfo.has_login())&#123;</span><br><span class="line">    &#x2F;&#x2F;打开需要展示给用户的页面，或者是调用远端接口</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    wv_login.show(&#39;slide-in-up&#39;);   &#x2F;&#x2F;从底部向上滑出登录页面</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在登录页面中，用户输入了用户名和密码后，并点击了”登录“按钮，我们下一步做什么？再插段代码（<strong>注意：此处使用的是我刚才代码中扩展的web_query函数，你也可以直接使用mui的ajax</strong>）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">get_pwd_hash</span><span class="params">(pwd)</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> salt = <span class="string">&#x27;hbuilder&#x27;</span>;  <span class="comment">//此处的salt是为了避免黑客撞库，而在md5之前对原文做一定的变形，可以设为自己喜欢的，只要和服务器验证时的salt一致即可。</span></span><br><span class="line">    <span class="keyword">return</span> md5(salt + pwd); <span class="comment">//此处假设你已经引用了md5相关的库，比如github上的JavaScript-MD5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里假设你已经通过DOM操作获取到了用户名和密码，分别保存在username和password变量中。</span></span><br><span class="line"><span class="keyword">var</span> username = xxx;</span><br><span class="line"><span class="keyword">var</span> password = xxx;</span><br><span class="line"><span class="keyword">var</span> pwd_hash = get_pwd_hash(password);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> onSuccess = function(data)&#123;</span><br><span class="line">    UserInfo.username(username);</span><br><span class="line">    UserInfo.password(pwd_hash);</span><br><span class="line">    UserInfo.token(data.token); <span class="comment">//把获取到的token保存到storage中</span></span><br><span class="line">    <span class="keyword">var</span> wc = plus.webview.currentWebview();</span><br><span class="line">    wc.hide(<span class="string">&#x27;slide-out-bottom&#x27;</span>);    <span class="comment">//此处假设是隐藏登录页回到之前的页面，实际你也可以干点儿别的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> onError = function(errcode)&#123;</span><br><span class="line">    <span class="keyword">switch</span>(errcode)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;INCORRECT_PASSWORD&#x27;</span>:</span><br><span class="line">        mui.toast(<span class="string">&#x27;密码不正确&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;USER_NOT_EXISTS&#x27;</span>:</span><br><span class="line">        mui.toast(<span class="string">&#x27;用户尚未注册&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mui.web_query(<span class="string">&#x27;get_token&#x27;</span>, &#123;username:username,password:pwd_hash&#125;, onSuccess, onError, <span class="number">3</span>);</span><br></pre></td></tr></table></figure><h6 id="更安全一点，获取token通过SSL"><a href="#更安全一点，获取token通过SSL" class="headerlink" title="更安全一点，获取token通过SSL"></a>更安全一点，获取token通过SSL</h6><p>刚才的方法，机智一点儿的读者大概会心存疑虑：那获取token时不还是得明文传输一次密码吗？<br>是的，你可以将这个获取token的地址，用SSL来保护（比如<a target="_blank" rel="noopener" href="https://api.abc.com/get_token/%EF%BC%89%EF%BC%8C%E8%BF%99%E6%A0%B7%E9%BB%91%E5%AE%A2%E5%8D%B3%E4%BD%BF%E6%88%AA%E4%BA%86%E5%8C%85%EF%BC%8C%E4%B8%80%E6%97%B6%E5%8D%8A%E4%BC%9A%E5%84%BF%E4%B9%9F%E8%A7%A3%E4%B8%8D%E5%87%BA%E4%BB%80%E4%B9%88%E4%BF%A1%E6%81%AF%E3%80%82">https://api.abc.com/get_token/），这样黑客即使截了包，一时半会儿也解不出什么信息。</a><br>SSL证书的获取渠道很多，我相信你总有办法查到，所以不废话了。不过话说namecheap上的SSL证书比godaddy的要便宜得多……（这是吐槽）<br><code>tips:</code>前段时间OpenSSL漏洞让很多服务器遭殃，所以如果自己搭服务器，一定记得装补丁。<br><code>tips:</code>可以把所有接口都弄成SSL的吗？可以。但会拖慢服务器，如果是配置并不自信的VPS，建议不折腾。</p><h6 id="如果更安全呢？"><a href="#如果更安全呢？" class="headerlink" title="如果更安全呢？"></a>如果更安全呢？</h6><p>还记得刚才APP向服务器请求token时，可以加入的用户信息吗？比如用户的设备deviceid。<br>如果我们在调用接口时，还附带一个当前时间戳参数timestamp，同时，用deviceid和这个时间戳再生成一个参数sign，比如 md5(deviceid timestamp token)这样的形式。而服务端首先验证一下参数中的时间戳与当前服务器时间是否一致（误差保持在合理范围内即可，比如5分钟），然后根据用户保存在服务器中的deviceid来对参数中的时间戳进行相同的变形，验证是否匹配，那便自然“更更安全”了。<br><code>tips:</code>如果对整个调用请求中的参数进行排序，再以<code>deviceid</code>和<code>timestamp</code>加上排序后的参数来对整个调用生成1个sign，黑客即使截获sign，不同的时间点、参数请求所使用的sign也是不同的，难以伪造，自然会更安全。当然，写起来也更费事。<br><code>tips:</code>明白了原理，整个验证过程是可以根据自己的需求改造的。</p></div><div class="article-licensing box"><div class="licensing-title"><p>APP接口安全TOKEN设计</p><p><a href="http://leihuazhe.github.io/p/821bbecd.html">http://leihuazhe.github.io/p/821bbecd.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Zane Ray</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2017-09-01</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-05-06</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/java/">java</a></div></div></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/gathering_qr.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/p/15049d29.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Jquery遍历与JS事件单独处理</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/p/1bda8925.html"><span class="level-item">hexo+github搭建博客</span><i class="level-item fas fa-chevron-right"></i></a></div></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen order-1"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#你是否真的需要登录功能？"><span class="level-left"><span class="level-item">1</span><span class="level-item">你是否真的需要登录功能？</span></span></a></li><li><a class="level is-mobile" href="#登录和注册要足够简单"><span class="level-left"><span class="level-item">2</span><span class="level-item">登录和注册要足够简单</span></span></a></li><li><a class="level is-mobile" href="#实现登录后的session有几种方式？"><span class="level-left"><span class="level-item">3</span><span class="level-item">实现登录后的session有几种方式？</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#调用后端接口"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">调用后端接口</span></span></a></li></ul></li><li><a class="level is-mobile" href="#调用后端接口怎么样才安全？"><span class="level-left"><span class="level-item">4</span><span class="level-item">调用后端接口怎么样才安全？</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#如果更安全呢？"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">如果更安全呢？</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list>li>a.is-active+.menu-list{display:block}#toc .menu-list>li>a+.menu-list{display:none}</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><figure class="media-left"><a class="image" href="/p/ac45747d.html"><img src="/gallery/covers/56_1.jpg" alt="Spring 学习 [1]"></a></figure><div class="media-content"><p class="date"><time datetime="2021-05-07T02:54:53.000Z">2021-05-07</time></p><p class="title"><a href="/p/ac45747d.html">Spring 学习 [1]</a></p><p class="categories"><a href="/categories/Scala/">Scala</a></p></div></article><article class="media"><figure class="media-left"><a class="image" href="/p/a8949b93.html"><img src="/gallery/covers/56_1.jpg" alt="Scala实战 -- 对List中的部分元素进行合并操作"></a></figure><div class="media-content"><p class="date"><time datetime="2019-04-01T11:43:12.000Z">2019-04-01</time></p><p class="title"><a href="/p/a8949b93.html">Scala实战 -- 对List中的部分元素进行合并操作</a></p><p class="categories"><a href="/categories/Scala/">Scala</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2019-01-09T16:00:00.000Z">2019-01-10</time></p><p class="title"><a href="/p/6e951315.html">🎮 Play 入门与学习(五) 2.5.x 版本自定义 Action</a></p><p class="categories"><a href="/categories/Play/">Play</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2018-12-24T16:00:00.000Z">2018-12-25</time></p><p class="title"><a href="/p/87290a79.html">🎮 Play 入门与学习(五) Dependency Injection</a></p><p class="categories"><a href="/categories/Play/">Play</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2018-12-16T16:00:00.000Z">2018-12-17</time></p><p class="title"><a href="/p/fe729f21.html">🎮 Play 入门与学习(三) Asynchronous results</a></p><p class="categories"><a href="/categories/Play/">Play</a></p></div></article></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dubbo/"><span class="tag">Dubbo</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span class="tag">Nginx</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Play/"><span class="tag">Play</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Scala/"><span class="tag">Scala</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring/"><span class="tag">Spring</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zookeeper/"><span class="tag">Zookeeper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/angular/"><span class="tag">angular</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/etcd/"><span class="tag">etcd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/rocketmq/"><span class="tag">rocketmq</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring/"><span class="tag">spring</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%89%8D%E7%AB%AF/"><span class="tag">前端</span><span class="tag">2</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/maple.png" alt="非普通程序员" height="28"></a><p class="is-size-7"><span>&copy; 2021 Zane Ray</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener("DOMContentLoaded",function(){loadInsight({contentUrl:"/content.json"},{hint:"想要查找什么...",untitled:"(无标题)",posts:"文章",pages:"页面",categories:"分类",tags:"标签"})})</script></body></html>